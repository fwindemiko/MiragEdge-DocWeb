name: 测试构建部署工作流

on:
  push:
    branches: ["main"]
  pull_request:
    branches: ["main"]

jobs:
  build-and-test:
    runs-on: ubuntu-latest
    env:
      NODE_VERSION: 22.x
      TEST_OUTPUT_DIR: test_tool
      VITEST_OUTPUT: test_tool/test/test-results/test-output.json
      VITEST_COVERAGE: test_tool/test/coverage

    steps:
      - uses: actions/checkout@v4

      - name: 使用 Node.js ${{ env.NODE_VERSION }}
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: "npm"
          cache-dependency-path: "**/package-lock.json"

      - name: 安装npm依赖包
        run: npm ci

      - name: 复制 mark.js依赖包
        run: cp -rf ./.vitepress/mark.js ./node_modules/

      - name: 创建测试报告输出目录
        run: |
          mkdir -p ${{ env.TEST_OUTPUT_DIR }}/test/coverage
          mkdir -p ${{ env.TEST_OUTPUT_DIR }}/test/test-results
          mkdir -p ${{ env.TEST_OUTPUT_DIR }}/test/logs
          echo "测试目录创建成功"

      - name: 构建网页项目
        run: npm run build

      - name: 运行测试并输出报告
        id: tests
        run: |
          echo "开始执行测试..."
          npm run test:coverage 2>&1 | tee ${{ env.TEST_OUTPUT_DIR }}/test/logs/test-output.log
          
          # 记录退出代码
          TEST_EXIT_CODE=${PIPESTATUS[0]}
          echo "测试退出码: $TEST_EXIT_CODE"
          
          # 验证测试输出文件
          if [ -f "${{ env.TEST_OUTPUT_DIR }}/test/test-results/test-output.json" ]; then
            echo "✓ 测试报告生成成功"
          else
            echo "✗ 测试报告未生成"
          fi
          
          if [ -d "${{ env.TEST_OUTPUT_DIR }}/test/coverage" ]; then
            echo "✓ 覆盖率报告生成成功"
          else
            echo "✗ 覆盖率报告未生成"
          fi
          
          exit $TEST_EXIT_CODE
        continue-on-error: true

      - name: 更新测试工件
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: test-results-${{ github.run_id }}
          path: ${{ env.TEST_OUTPUT_DIR }}/test/
          retention-days: 7

      - name: 测试统计信息输出总结
        if: always()
        run: |
          echo "=== 测试执行摘要 ==="
          echo "测试结果: ${{ steps.tests.outcome }}"
          
          if [ -f "${{ env.TEST_OUTPUT_DIR }}/test/logs/test-output.log" ]; then
            echo "=== 测试日志最后20行 ==="
            tail -20 ${{ env.TEST_OUTPUT_DIR }}/test/logs/test-output.log
          fi
          
          echo "=== 测试结果目录 ==="
          echo "覆盖率: ${{ env.TEST_OUTPUT_DIR }}/test/coverage/"
          echo "报告: ${{ env.TEST_OUTPUT_DIR }}/test/test-results/"
          echo "日志: ${{ env.TEST_OUTPUT_DIR }}/test/logs/"

      # ---------- 部署阶段 ----------
      - name: 设置 SSH 代理
        if: github.event_name == 'push' && github.ref == 'refs/heads/main' && success()
        uses: webfactory/ssh-agent@v0.5.3
        with:
          ssh-private-key: ${{ secrets.actions }}

      - name: 添加 SSH 已知主机
        if: github.event_name == 'push' && github.ref == 'refs/heads/main' && success()
        run: |
          ssh-keyscan -H miragedge.top >> ~/.ssh/known_hosts

      - name: 部署到服务器（含 rsync 强制安装与路径检查）
        if: github.event_name == 'push' && github.ref == 'refs/heads/main' && success()
        run: |
          # 强制确保 rsync 可用
          sudo apt-get update
          sudo apt-get install --reinstall -y rsync
          
          # 查找 rsync 的绝对路径（若仍未找到则报错）
          RSYNC_CMD=$(command -v rsync)
          if [ -z "$RSYNC_CMD" ]; then
            echo "错误：rsync 仍未安装成功！"
            exit 1
          fi
          echo "使用 rsync 路径: $RSYNC_CMD"

          # 定义远程服务器信息
          REMOTE_USER="root"
          REMOTE_HOST="miragedge.top"
          REMOTE_PORT="22"
          REMOTE_PATH="/www/MiragEdge/build/"

          # 自动探测构建输出目录
          if [ -d "./dist" ]; then
            BUILD_DIR="./dist"
          elif [ -d "./.vitepress/dist" ]; then
            BUILD_DIR="./.vitepress/dist"
          else
            echo "错误：未找到构建输出目录（dist 或 .vitepress/dist）"
            exit 1
          fi
          echo "使用构建目录: $BUILD_DIR"

          # 确保远程目录存在
          ssh -p $REMOTE_PORT ${REMOTE_USER}@${REMOTE_HOST} "mkdir -p ${REMOTE_PATH}"

          # 使用 rsync 同步文件（使用绝对路径）
          $RSYNC_CMD -avz --delete -e "ssh -p $REMOTE_PORT" ${BUILD_DIR}/ ${REMOTE_USER}@${REMOTE_HOST}:${REMOTE_PATH}

          echo "部署完成！"
name: 测试构建部署工作流

on:
  push:
    branches: ["main"]
  pull_request:
    branches: ["main"]

jobs:
  build-and-test:
    runs-on: ubuntu-latest
    env:
      NODE_VERSION: 22.x
      TEST_OUTPUT_DIR: test_tool
      VITEST_OUTPUT: test_tool/test/test-results/test-output.json
      VITEST_COVERAGE: test_tool/test/coverage

    steps:
      - uses: actions/checkout@v4

      - name: 使用 Node.js ${{ env.NODE_VERSION }}
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: "npm"
          cache-dependency-path: "**/package-lock.json"

      - name: 安装npm依赖包
        run: npm ci

      - name: 复制 mark.js依赖包
        run: cp -rf ./.vitepress/mark.js ./node_modules/

      - name: 创建测试报告输出目录
        run: |
          mkdir -p ${{ env.TEST_OUTPUT_DIR }}/test/coverage
          mkdir -p ${{ env.TEST_OUTPUT_DIR }}/test/test-results
          mkdir -p ${{ env.TEST_OUTPUT_DIR }}/test/logs
          echo "测试目录创建成功"

      - name: 构建网页项目
        run: npm run build

      - name: 运行测试并输出报告
        id: tests
        run: |
          echo "开始执行测试..."
          npm run test:coverage 2>&1 | tee ${{ env.TEST_OUTPUT_DIR }}/test/logs/test-output.log
          
          # 记录退出代码
          TEST_EXIT_CODE=${PIPESTATUS[0]}
          echo "测试退出码: $TEST_EXIT_CODE"
          
          # 验证测试输出文件
          if [ -f "${{ env.TEST_OUTPUT_DIR }}/test/test-results/test-output.json" ]; then
            echo "✓ 测试报告生成成功"
          else
            echo "✗ 测试报告未生成"
          fi
          
          if [ -d "${{ env.TEST_OUTPUT_DIR }}/test/coverage" ]; then
            echo "✓ 覆盖率报告生成成功"
          else
            echo "✗ 覆盖率报告未生成"
          fi
          
          exit $TEST_EXIT_CODE
        continue-on-error: true

      - name: 更新测试工件
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: test-results-${{ github.run_id }}
          path: ${{ env.TEST_OUTPUT_DIR }}/test/
          retention-days: 7

      - name: 测试统计信息输出总结
        if: always()
        run: |
          echo "=== 测试执行摘要 ==="
          echo "测试结果: ${{ steps.tests.outcome }}"
          
          if [ -f "${{ env.TEST_OUTPUT_DIR }}/test/logs/test-output.log" ]; then
            echo "=== 测试日志最后20行 ==="
            tail -20 ${{ env.TEST_OUTPUT_DIR }}/test/logs/test-output.log
          fi
          
          echo "=== 测试结果目录 ==="
          echo "覆盖率: ${{ env.TEST_OUTPUT_DIR }}/test/coverage/"
          echo "报告: ${{ env.TEST_OUTPUT_DIR }}/test/test-results/"
          echo "日志: ${{ env.TEST_OUTPUT_DIR }}/test/logs/"

      # ---------- 打包构建产物 ----------
      - name: 打包构建产物
        if: github.event_name == 'push' && github.ref == 'refs/heads/main' && success()
        id: package
        run: |
          # 自动探测构建输出目录
          if [ -d "./.vitepress/dist" ]; then
            BUILD_DIR="./.vitepress/dist"
          elif [ -d "./dist" ]; then
            BUILD_DIR="./dist"
          else
            echo "错误：未找到构建输出目录（dist 或 .vitepress/dist）"
            exit 1
          fi
          echo "使用构建目录: $BUILD_DIR"

          # 定义打包文件名
          PACKAGE_NAME="build-${{ github.run_id }}.tar.gz"
          echo "PACKAGE_NAME=$PACKAGE_NAME" >> $GITHUB_ENV
          echo "BUILD_DIR=$BUILD_DIR" >> $GITHUB_ENV

          # 切换到父目录，打包构建目录
          cd "$(dirname "$BUILD_DIR")"
          # 使用 gzip -9 最高压缩级别
          tar -c "$(basename "$BUILD_DIR")" | gzip -9 > "${{ runner.temp }}/$PACKAGE_NAME"
          echo "打包完成: ${{ runner.temp }}/$PACKAGE_NAME (gzip -9)"

      # ---------- 上传打包文件为 GitHub 工件 ----------
      - name: 输出构建产物
        if: github.event_name == 'push' && github.ref == 'refs/heads/main' && success()
        uses: actions/upload-artifact@v4
        with:
          name: built-site-${{ github.run_id }}
          path: ${{ runner.temp }}/build-${{ github.run_id }}.tar.gz
          retention-days: 12
          if-no-files-found: error

      # ---------- 部署阶段 ----------
      - name: 设置 SSH 代理
        if: github.event_name == 'push' && github.ref == 'refs/heads/main' && success()
        uses: webfactory/ssh-agent@v0.5.3
        with:
          ssh-private-key: ${{ secrets.actions }}

      - name: 添加 SSH 已知主机
        if: github.event_name == 'push' && github.ref == 'refs/heads/main' && success()
        run: |
          ssh-keyscan -H miragedge.top >> ~/.ssh/known_hosts

      - name: 部署到服务器
        if: github.event_name == 'push' && github.ref == 'refs/heads/main' && success()
        run: |
          # 定义远程服务器信息
          REMOTE_USER="root"
          REMOTE_HOST="miragedge.top"
          REMOTE_PORT="22"
          REMOTE_PATH="/www/MiragEdge/MiragEdge-DocWeb/build/miragedge.top/"
          PACKAGE_NAME="build-${{ github.run_id }}.tar.gz"
          LOCAL_PACKAGE="${{ runner.temp }}/$PACKAGE_NAME"

          # 1. 确保远程目标目录存在
          ssh -p $REMOTE_PORT ${REMOTE_USER}@${REMOTE_HOST} "mkdir -p ${REMOTE_PATH}"

          # 2. 上传压缩包到远程服务器临时位置（如 /tmp）
          scp -P $REMOTE_PORT $LOCAL_PACKAGE ${REMOTE_USER}@${REMOTE_HOST}:/tmp/$PACKAGE_NAME

          # 3. 远程解压到目标目录并清理
          ssh -p $REMOTE_PORT ${REMOTE_USER}@${REMOTE_HOST} "
            set -e
            echo '解压中...'
            # 清空目标目录（保留目录本身）
            rm -rf ${REMOTE_PATH}*
            # 解压到目标目录（假设包内包含一个顶层目录，需 strip 第一层）
            tar -xzf /tmp/$PACKAGE_NAME -C ${REMOTE_PATH} --strip-components=1
            # 删除临时压缩包
            rm -f /tmp/$PACKAGE_NAME
            echo '解压完成，目录内容：'
            ls -la ${REMOTE_PATH}
          "

          echo "部署完成！"